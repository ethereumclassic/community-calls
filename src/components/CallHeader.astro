---
import type { Call } from "../lib/types";
import { Icon } from "astro-icon/components";
import TimezoneBar from "./TimezoneBar.astro";
import GreenRoom from "./GreenRoom.astro";
import UpcomingBadge from "./UpcomingBadge.astro";
import LiveBadge from "./LiveBadge.astro";
import AddToCalendarButtons from "./AddToCalendarButtons.astro";
import {
  formatFullDate,
  formatTime,
  combineDateAndTime,
  getTimezoneDateNote,
} from "../lib/dates";
import { siteConfig } from "../lib/config";
import type { CalendarEvent } from "../lib/calendar-links";

interface Props {
  call: Call;
}

const { call } = Astro.props;

const callNumber = call.data.callNumber!;
const isUpcoming = call.data.isUpcoming;
const joinModalId = `join-call-modal-${callNumber}`;
const timezoneNote = getTimezoneDateNote(call.data.date, call.data.time);

// Build calendar event for add-to-calendar buttons
const icsUrl = `${siteConfig.url}/calls/${call.data.slug}.ics`;
const startDate = combineDateAndTime(call.data.date, call.data.time);
const endDate = new Date(startDate);
endDate.setUTCHours(endDate.getUTCHours() + 2);
const callUrl = `${siteConfig.url}/calls/${call.data.slug}`;

let calendarDescription = `Ethereum Classic Community Call #${callNumber}`;
calendarDescription += `\n\n${call.data.description}`;
calendarDescription += `\n\nMore info: ${callUrl}`;
if (call.data.joinLink) {
  calendarDescription += `\nJoin: ${call.data.joinLink}`;
}

const calendarEvent: CalendarEvent = {
  title: `ETC Community Call #${callNumber}: ${call.data.description}`,
  description: calendarDescription,
  location: call.data.location,
  startDate,
  endDate,
  url: callUrl,
};
---

<header class="mb-10">
  <!-- Status badge -->
  <div class="flex items-center gap-3 mb-8 h-[26px]">
    {
      call.data.youtube ? (
        <LiveBadge color="green">Recorded</LiveBadge>
      ) : (
        isUpcoming &&
        call.data.eventDateTime && (
          <UpcomingBadge eventDateTime={call.data.eventDateTime} />
        )
      )
    }
  </div>

  <!-- Title -->
  {
    callNumber !== 0 && (
      <p class="text-base md:text-lg font-mono text-gray-400 mb-4">
        Ethereum Classic Community Call #{callNumber}
      </p>
    )
  }
  <h1 class="font-display text-6xl md:text-6xl text-white mb-4">
    {call.data.description}
  </h1>
  <!-- Meta info -->
  <div class="text-base md:text-lg font-mono text-gray-400 mb-8">
    {formatFullDate(call.data.date)} at {formatTime(call.data.time)}{
      timezoneNote
    }
  </div>

  <!-- Timezone Display -->
  <TimezoneBar time={call.data.time} date={call.data.date} />

  <!-- Join Call Button & Green Room (only for upcoming calls with join link) -->
  {
    isUpcoming &&
      call.data.joinLink &&
      !call.data.youtube &&
      call.data.greenRoom && (
        <div class="mt-6 flex flex-col md:flex-row md:items-center gap-4">
          <a
            href={call.data.joinLink}
            data-modal-trigger={joinModalId}
            class="flex md:inline-flex items-center justify-center gap-5 px-6 py-4 bg-etc-green text-void font-mono text-base font-semibold uppercase tracking-wider rounded-lg hover:bg-etc-green/90 transition-colors whitespace-nowrap cursor-pointer"
          >
            <Icon name="lucide:phone" class="icon-lg" />
            Join Call
            <br class="hidden md:inline" />
            on {call.data.location}
          </a>
          <GreenRoom
            time={call.data.greenRoom.time}
            location={call.data.greenRoom.location}
            joinLink={call.data.greenRoom.joinLink}
          />
        </div>
      )
  }

  <!-- Add to Calendar (for upcoming calls) -->
  {
    isUpcoming && !call.data.youtube && (
      <div class="mt-6">
        <AddToCalendarButtons event={calendarEvent} icsUrl={icsUrl} />
      </div>
    )
  }
</header>
