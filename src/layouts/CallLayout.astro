---
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
import PageLayout from "./PageLayout.astro";
import TimezoneBar from "../components/TimezoneBar.astro";
import TerminalCard from "../components/TerminalCard.astro";
import AnimatedContainer from "../components/AnimatedContainer.astro";
import GreenRoom from "../components/GreenRoom.astro";
import UpcomingBadge from "../components/UpcomingBadge";
import { formatFullDate, formatShortDate } from "../lib/dates";

interface Props {
  call: CollectionEntry<"calls">;
  prevCall?: CollectionEntry<"calls"> | null;
  nextCall?: CollectionEntry<"calls"> | null;
}

const { call, prevCall, nextCall } = Astro.props;

// Use computed fields from loader
const callNumber = call.data.callNumber!;
const youtubeId = call.data.youtubeId;
const isUpcoming = call.data.date ? call.data.date > new Date() : false;

const baseTitle = `ETC Community Call ${callNumber}`;
const title = call.data.description
  ? `${baseTitle} - ${call.data.description}`
  : baseTitle;

// Prev/next navigation info
const prevNumber = prevCall?.data.callNumber;
const nextNumber = nextCall?.data.callNumber;
const prevSlug = prevCall?.data.slug;
const nextSlug = nextCall?.data.slug;
const prevDate = prevCall?.data.date
  ? formatShortDate(prevCall.data.date)
  : null;
const nextDate = nextCall?.data.date
  ? formatShortDate(nextCall.data.date)
  : null;
const prevDesc = prevCall?.data.description || "";
const nextDesc = nextCall?.data.description || "";

// Build tooltip text
const prevTooltip = prevCall
  ? `Call ${prevNumber}${prevDate ? ` • ${prevDate}` : ""}${prevDesc ? `\n${prevDesc}` : ""}`
  : "";
const nextTooltip = nextCall
  ? `Call ${nextNumber}${nextDate ? ` • ${nextDate}` : ""}${nextDesc ? `\n${nextDesc}` : ""}`
  : "";
---

<PageLayout title={title} description={call.data.description} maxWidth="narrow">
  <AnimatedContainer as="article" delay={100}>
    <!-- Navigation Bar -->
    <nav class="flex items-center justify-between mb-8">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-xs font-mono uppercase tracking-wider text-gray-500 hover:text-etc-green transition-colors group"
      >
        <Icon name="lucide:chevron-left" class="icon-sm transform group-hover:-translate-x-1 transition-transform" />
        Archive
      </a>
      {
        (prevSlug || nextSlug) && (
          <div class="flex items-center gap-1 text-sm font-mono bg-surface-elevated/50 rounded-lg px-1 py-1 border border-etc-green/10">
            {prevSlug && (
              <a
                href={`/calls/${prevSlug}`}
                class="px-3 py-1 text-gray-300 hover:text-etc-green hover:bg-etc-green/10 rounded transition-colors"
                title={prevTooltip}
              >
                &larr; {prevNumber}
              </a>
            )}
            {prevSlug && nextSlug && <span class="text-gray-600">|</span>}
            {nextSlug && (
              <a
                href={`/calls/${nextSlug}`}
                class="px-3 py-1 text-gray-300 hover:text-etc-green hover:bg-etc-green/10 rounded transition-colors"
                title={nextTooltip}
              >
                {nextNumber} &rarr;
              </a>
            )}
          </div>
        )
      }
    </nav>

    <!-- Header -->
    <header class="mb-10">
      <!-- Status badge -->
      <div class="flex items-center gap-3 mb-4">
        {
          call.data.youtube ? (
            <span class="inline-flex items-center gap-2 px-3 py-1 text-[10px] font-mono uppercase tracking-widest text-etc-green/80 border border-etc-green/20 rounded-full">
              <span class="w-1.5 h-1.5 rounded-full bg-etc-green animate-pulse-glow" />
              Recorded
            </span>
          ) : call.data.date && call.data.time && (
            <UpcomingBadge
              client:only="react"
              date={call.data.date.toISOString()}
              time={call.data.time}
            />
          )
        }
      </div>

      <!-- Title -->
      {callNumber === 0 ? (
        <h1 class="font-display text-4xl md:text-5xl text-gray-100 mb-4">
          {call.data.description}
        </h1>
      ) : (
        <>
          <h1 class="font-display text-4xl md:text-5xl text-gray-100 mb-4">
            Ethereum Classic Community Call #{callNumber}
          </h1>

          <!-- Description -->
          {
            call.data.description && (
              <p class="text-xl font-mono text-gray-400 mb-6">
                {call.data.description}
              </p>
            )
          }
        </>
      )}

      <!-- Meta info -->
      <div class="flex flex-wrap items-center gap-4 text-sm font-mono">
        {
          call.data.date && (
            <span class="text-gray-400">
              <span class="text-etc-green/60">date:</span>{" "}
              {formatFullDate(call.data.date)}
            </span>
          )
        }
        {
          call.data.time && (
            <span class="text-gray-400">
              <span class="text-etc-green/60">time:</span> {call.data.time}
            </span>
          )
        }
        {
          call.data.location && (
            <span class="text-gray-400">
              <span class="text-etc-green/60">location:</span>{" "}
              {call.data.location}
            </span>
          )
        }
      </div>

      <!-- Timezone Display -->
      {call.data.time && <TimezoneBar time={call.data.time} />}

      <!-- Join Call Button & Green Room (only for upcoming calls) -->
      {isUpcoming && ((call.data.joinLink && !call.data.youtube) || call.data.greenRoom) ? (
        <div class="mt-6 flex flex-col md:flex-row md:items-center gap-4">
          {call.data.joinLink && !call.data.youtube && (
            <a
              href={call.data.joinLink}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-3 px-6 py-3 bg-etc-green text-void font-mono text-sm font-semibold uppercase tracking-wider rounded-lg hover:bg-etc-green/90 transition-colors whitespace-nowrap"
            >
              <Icon name="lucide:video" class="icon-sm" />
              Join Call
            </a>
          )}
          {call.data.greenRoom && (
            <GreenRoom
              time={call.data.greenRoom.time}
              location={call.data.greenRoom.location}
              joinLink={call.data.greenRoom.joinLink}
            />
          )}
        </div>
      ) : null}
    </header>

    <!-- YouTube Embed -->
    {
      youtubeId && (
        <AnimatedContainer as="section" delay={200} class="mb-10">
          <TerminalCard showDots title={`rec_${call.data.date?.toISOString().split("T")[0].replace(/-/g, "")}_${String(callNumber).padStart(3, "0")}.mp4`} titleLink={`https://www.youtube.com/watch?v=${youtubeId}`}>
            <div class="aspect-video">
              <iframe
                width="100%"
                height="100%"
                src={`https://www.youtube.com/embed/${youtubeId}`}
                title={title}
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                class="border-0"
              />
            </div>
          </TerminalCard>
        </AnimatedContainer>
      )
    }

    <!-- Hosts -->
    {
      call.data.hosts && call.data.hosts.length > 0 && (
        <AnimatedContainer as="section" delay={300} class="mb-10">
          <TerminalCard class="p-5">
            <div class="flex flex-wrap gap-6">
              {call.data.hosts.map((host, index) => (
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-etc-green/10 border border-etc-green/20 flex items-center justify-center">
                    <span class="text-etc-green text-sm font-mono">
                      {host.charAt(0)}
                    </span>
                  </div>
                  <div>
                    <div class="text-[10px] font-mono uppercase tracking-wider text-gray-500">
                      {index === 0 ? "Host" : "Co-host"}
                    </div>
                    <div class="text-sm font-mono text-gray-200">
                      {host}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </TerminalCard>
        </AnimatedContainer>
      )
    }

    <!-- Main Content -->
    <AnimatedContainer as="section" delay={400} class="prose prose-lg prose-invert max-w-none">
      <slot />
    </AnimatedContainer>
  </AnimatedContainer>
</PageLayout>
