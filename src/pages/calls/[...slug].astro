---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import TimezoneBar from '../../components/TimezoneBar.astro';

// Helper to extract call number from filename (fallback)
const getCallNumberFromFilename = (id: string) => {
  const match = id.match(/_(\d+)\.md$/);
  return match ? parseInt(match[1], 10) : 0;
};

// Get call number from frontmatter or filename
const getCallNumberFromCall = (call: { id: string; data: { number?: number } }) => {
  if (call.data.number) return call.data.number;
  return getCallNumberFromFilename(call.id);
};

// Generate slug from call data
const getSlug = (call: { id: string; data: { date?: Date; description?: string; number?: number } }) => {
  const date = call.data.date;
  const num = call.data.number || getCallNumberFromFilename(call.id);
  const desc = call.data.description;

  if (date && desc) {
    const dateStr = date.toISOString().split('T')[0];
    const slugDesc = desc.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    return `${dateStr}-${num}-${slugDesc}`;
  }

  // Fallback to filename without extension
  return call.id.replace('.md', '');
};

export async function getStaticPaths() {
  const allCalls = await getCollection('calls');

  // Helper to get call number (inline for build context)
  const getNum = (call: typeof allCalls[0]) => {
    if (call.data.number) return call.data.number;
    const match = call.id.match(/_(\d+)\.md$/);
    return match ? parseInt(match[1], 10) : 0;
  };

  // Helper to generate slug (inline for build context)
  const makeSlug = (call: typeof allCalls[0]) => {
    const date = call.data.date;
    const num = getNum(call);
    const desc = call.data.description;
    if (date && desc) {
      const dateStr = date.toISOString().split('T')[0];
      const slugDesc = desc.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      return `${dateStr}-${num}-${slugDesc}`;
    }
    return call.id.replace('.md', '');
  };

  // Filter out addendum pages and recurring call info, then sort by call number
  const sortedCalls = allCalls
    .filter(call => !call.id.includes('addendum') && !call.id.includes('recurring'))
    .sort((a, b) => getNum(a) - getNum(b));

  return sortedCalls.map((call, index) => ({
    params: { slug: makeSlug(call) },
    props: {
      call,
      prevCall: index > 0 ? sortedCalls[index - 1] : null,
      nextCall: index < sortedCalls.length - 1 ? sortedCalls[index + 1] : null,
    },
  }));
}

const { call, prevCall, nextCall } = Astro.props;
const { Content } = await render(call);

const callNumber = getCallNumberFromCall(call);
const title = call.data.title || call.data.name || `ETC Community Call ${callNumber}`;

const formatDate = (d: Date) => {
  return d.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

// Extract YouTube video ID for embed
const getYouTubeId = (url: string) => {
  const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/))([^&?]+)/);
  return match ? match[1] : null;
};

const youtubeId = call.data.youtube ? getYouTubeId(call.data.youtube) : null;

// Format date for navigation buttons
const formatShortDate = (d: Date) => {
  return d.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

// Prev/next navigation info
const prevNumber = prevCall ? getCallNumberFromCall(prevCall) : null;
const nextNumber = nextCall ? getCallNumberFromCall(nextCall) : null;
const prevSlug = prevCall ? getSlug(prevCall) : null;
const nextSlug = nextCall ? getSlug(nextCall) : null;
const prevDate = prevCall?.data.date ? formatShortDate(prevCall.data.date) : null;
const nextDate = nextCall?.data.date ? formatShortDate(nextCall.data.date) : null;
const prevDesc = prevCall?.data.description || '';
const nextDesc = nextCall?.data.description || '';

// Build tooltip text
const prevTooltip = prevCall ? `Call ${prevNumber}${prevDate ? ` • ${prevDate}` : ''}${prevDesc ? `\n${prevDesc}` : ''}` : '';
const nextTooltip = nextCall ? `Call ${nextNumber}${nextDate ? ` • ${nextDate}` : ''}${nextDesc ? `\n${nextDesc}` : ''}` : '';
---

<Layout title={title} description={call.data.description}>
  <article class="max-w-4xl mx-auto opacity-0 animate-fade-in-up" style="animation-delay: 100ms">
    <!-- Navigation Bar -->
    <nav class="flex items-center justify-between mb-8">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-xs font-mono uppercase tracking-wider text-gray-500 hover:text-etc-green transition-colors group"
      >
        <svg class="w-4 h-4 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Archive
      </a>
      {(prevSlug || nextSlug) && (
        <div class="flex items-center gap-1 text-sm font-mono bg-surface-elevated/50 rounded-lg px-1 py-1 border border-etc-green/10">
          {prevSlug && (
            <a href={`/calls/${prevSlug}`} class="px-3 py-1 text-gray-300 hover:text-etc-green hover:bg-etc-green/10 rounded transition-colors" title={prevTooltip}>
              &larr; {prevNumber}
            </a>
          )}
          {prevSlug && nextSlug && <span class="text-gray-600">|</span>}
          {nextSlug && (
            <a href={`/calls/${nextSlug}`} class="px-3 py-1 text-gray-300 hover:text-etc-green hover:bg-etc-green/10 rounded transition-colors" title={nextTooltip}>
              {nextNumber} &rarr;
            </a>
          )}
        </div>
      )}
    </nav>

    <!-- Header -->
    <header class="mb-10">
      <!-- Call number badge -->
      <div class="flex items-center gap-3 mb-4">
        <span class="inline-flex items-center gap-2 px-3 py-1 text-[10px] font-mono uppercase tracking-widest text-etc-green/80 border border-etc-green/20 rounded-full">
          <span class="w-1.5 h-1.5 rounded-full bg-etc-green animate-pulse-glow"></span>
          Call #{callNumber}
        </span>
        {call.data.youtube && (
          <span class="badge-recording px-2 py-0.5 rounded text-[9px]">
            Recorded
          </span>
        )}
      </div>

      <!-- Title -->
      <h1 class="font-display text-4xl md:text-5xl text-gray-100 mb-4">
        {title.replace(/ETC Community Call \d+/, '').trim() || 'Community Call'}
      </h1>

      <!-- Description -->
      {call.data.description && (
        <p class="text-xl font-mono text-gray-400 mb-6">{call.data.description}</p>
      )}

      <!-- Meta info -->
      <div class="flex flex-wrap items-center gap-4 text-sm font-mono">
        {call.data.date && (
          <span class="text-gray-400">
            <span class="text-etc-green/60">date:</span> {formatDate(call.data.date)}
          </span>
        )}
        {call.data.time && (
          <span class="text-gray-400">
            <span class="text-etc-green/60">time:</span> {call.data.time}
          </span>
        )}
        {call.data.location && (
          <span class="text-gray-400">
            <span class="text-etc-green/60">location:</span> {call.data.location}
          </span>
        )}
      </div>

      <!-- Timezone Display -->
      {call.data.time && (
        <TimezoneBar time={call.data.time} />
      )}
    </header>

    <!-- YouTube Embed -->
    {youtubeId && (
      <section class="mb-10 opacity-0 animate-fade-in-up" style="animation-delay: 200ms">
        <div class="terminal-card rounded-xl overflow-hidden">
          <div class="flex items-center gap-2 px-4 py-2 bg-surface-elevated/50 border-b border-etc-green/10">
            <span class="w-2 h-2 rounded-full bg-red-500/60"></span>
            <span class="w-2 h-2 rounded-full bg-amber/60"></span>
            <span class="w-2 h-2 rounded-full bg-etc-green/60"></span>
            <span class="ml-3 text-[10px] font-mono text-gray-500">rec_{call.data.date?.toISOString().split('T')[0].replace(/-/g, '')}_{String(callNumber).padStart(3, '0')}.mp4</span>
          </div>
          <div class="aspect-video">
            <iframe
              width="100%"
              height="100%"
              src={`https://www.youtube.com/embed/${youtubeId}`}
              title={title}
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              class="border-0"
            ></iframe>
          </div>
        </div>
      </section>
    )}

    <!-- Host Info -->
    {(call.data.host || call.data.cohost) && (
      <section class="mb-10 opacity-0 animate-fade-in-up" style="animation-delay: 300ms">
        <div class="terminal-card rounded-xl p-5">
          <div class="flex flex-wrap gap-6">
            {call.data.host && (
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-etc-green/10 border border-etc-green/20 flex items-center justify-center">
                  <span class="text-etc-green text-sm font-mono">{call.data.host.charAt(0)}</span>
                </div>
                <div>
                  <div class="text-[10px] font-mono uppercase tracking-wider text-gray-500">Host</div>
                  <div class="text-sm font-mono text-gray-200">{call.data.host}</div>
                </div>
              </div>
            )}
            {call.data.cohost && (
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-etc-green/10 border border-etc-green/20 flex items-center justify-center">
                  <span class="text-etc-green text-sm font-mono">{call.data.cohost.charAt(0)}</span>
                </div>
                <div>
                  <div class="text-[10px] font-mono uppercase tracking-wider text-gray-500">Co-host</div>
                  <div class="text-sm font-mono text-gray-200">{call.data.cohost}</div>
                </div>
              </div>
            )}
          </div>
        </div>
      </section>
    )}

    <!-- Main Content -->
    <section class="prose prose-lg prose-invert max-w-none opacity-0 animate-fade-in-up" style="animation-delay: 400ms">
      <Content />
    </section>
  </article>
</Layout>
