---
import PageLayout from "../layouts/PageLayout.astro";
import LandingHero from "../components/LandingHero.astro";
import LandingAbout from "../components/LandingAbout.astro";
import UpcomingCall from "../components/UpcomingCall.astro";
import SubscribeBanner from "../components/SubscribeBanner.astro";
import ArchiveGrid from "../components/ArchiveGrid.astro";
import { getCalls, sortCallsByDate } from "../lib/calls";

const allCalls = await getCalls();

// Separate regular calls for stats and upcoming
const regularCalls = allCalls.filter((call) => !call.data.special);
const upcomingCalls = regularCalls.filter((call) => call.data.isUpcoming);

// Get the next upcoming call (soonest)
const nextCall =
  upcomingCalls.length > 0 ? sortCallsByDate(upcomingCalls, "asc")[0] : null;

// Stats (only count regular calls)
const totalCalls = regularCalls.length;
const recordedCalls = regularCalls.filter((c) => c.data.youtube).length;
---

<PageLayout title="ETC Community Calls">
  <LandingHero totalCalls={totalCalls} recordedCalls={recordedCalls} />
  <LandingAbout />
  {nextCall && <UpcomingCall call={nextCall} />}
  <SubscribeBanner />
  <ArchiveGrid />
</PageLayout>
